
Right now `viem` is defined at:
- root: `2.41.2`
- core: `2.43.3`
- sdk: `2.43.3`

Prefer one of:
- put `viem` only at root and use workspace protocol for all packages, or
- keep it per-package but ensure all packages use the exact same version.

---

## 4) Refactor Plan (v4) — staged, regression-safe

### Phase 0 (P0): Make quality gates real + lock down surface risks
**Deliverables**
- Fix root scripts so `lint` and `test` are deterministic and actually run.
- Remove node-only key utilities from the default SDK export surface.
- Add a “no accidental secrets” gate: ensure no default private keys are shipped in published artifacts.

**Key changes (conceptually)**
- Root `test` should run `vitest run` with root `vitest.config.ts`.
- Root `lint` should run root eslint config (or introduce one).
- SDK exports:
  - `@aastar/sdk` (browser-safe clients + types)
  - `@aastar/sdk/node` (KeyManager, filesystem helpers) or move to scripts-only.

### Phase 1 (P1): Typed client factory + action binding (reduce `as any`)
**Deliverables**
- One canonical function to construct clients and attach modules.
- Reduce `as any` usage sharply (goal: client layer → near-zero).
- Establish a typed “ContractCall” wrapper to standardize `.readContract/.writeContract/.simulateContract`.

### Phase 2 (P1): Error strategy unification (choose one of 2 and commit)
Pick one:

**Option A (DX-first for app dev): “Result-first”**
- All public SDK methods return `Promise<SDKResult<T>>`.
- `throw` only for programmer errors (invariants).

**Option B (ecosystem-default): “throw-first”**
- All public SDK methods throw `AAStarError` (typed, with code + details).
- `SDKResult` stays internal (for optional wrapping).

Whichever you choose, enforce it via tests and lint rules; remove parallel utilities.

### Phase 3 (P1): Gasless and AA orchestration consolidation
**Deliverables**
- Move all packing (accountGasLimits, gasFees, paymasterAndData) behind one builder API.
- Ensure EntryPoint version compatibility is explicit (v0.6/v0.7) and validated.
- Add “simulate first” optional mode for safety.

### Phase 4 (P2): Package boundaries + exports cleanup
**Deliverables**
- Stop re-exporting `@aastar/dapp` from `@aastar/sdk`.
- Split utils into runtime-safe vs node-only.
- Clarify which packages are “SDK runtime” vs “examples/scripts”.

### Phase 5 (P2): Testing matrix
**Deliverables**
- L1: unit tests for validation and packers
- L2: mocked viem client tests for orchestration ordering
- L3: optional anvil E2E (already exists via `run_full_regression.sh`)

---

## 5) Concrete Audit Notes (By File / Module)

### 5.1 `packages/core/src/abis/index.ts`
- ✅ `extractAbi()` and `Abis` namespace are correct direction.
- ⚠️ Still returns `any`-typed ABI; long-term: generate types or use `as const` ABI typing strategy.

### 5.2 `packages/core/src/utils/validation.ts`
- ✅ good baseline, covers address/hex/uint128 bounds.
- ⚠️ doesn’t enforce fixed-length hex for roleId / bytes32 (it validates hex syntax only).

### 5.3 `packages/sdk/src/clients/operator.ts`
- ✅ validates stake/deposit/roleId/gasTokens.
- ⚠️ mixes idempotent checks + orchestration + logging in one method.
- ⚠️ still heavy `client as any` usage; missing standardized error wrapper; returns thrown `Error`.

### 5.4 `packages/sdk/src/clients/admin.ts`
- ✅ namespacing exists and validation is applied for most functions.
- ⚠️ still binds actions via `baseClient as any`.

### 5.5 `packages/sdk/src/utils/keys.ts`
- ⚠️ should not be default-exported from SDK; keep node-only.

---

## 6) “Next 48 hours” suggested move (lowest risk, highest ROI)

1. Fix root `lint/test` scripts so they run deterministically (no recursive missing scripts).
2. Stop exporting node-only key utilities from `@aastar/sdk` main entry.
3. Introduce one typed client factory helper and migrate one client (Operator) as a pilot.
4. Decide error strategy (Result vs throw) and enforce it for the pilot client.

---

## Appendix: Observed signals from codebase
- SDK logging volume is high (many `console.log/warn/error`).
- Type casts are widely used in both SDK clients and core actions.
- `run_sdk_regression.sh` is comprehensive for integration/regression, but unit-level gates need wiring.

