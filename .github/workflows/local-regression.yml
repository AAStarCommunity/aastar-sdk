name: Local Regression Test

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Aastar-SDK
        uses: actions/checkout@v4
        with:
          path: aastar-sdk

      - name: Checkout SuperPaymaster (Submodule/Sibling)
        uses: actions/checkout@v4
        with:
          repository: AAStarCommunity/SuperPaymaster
          path: SuperPaymaster
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Install Pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          cache-dependency-path: aastar-sdk/pnpm-lock.yaml

      - name: Install Node Dependencies
        run: |
          cd aastar-sdk
          pnpm install

      - name: Start Anvil
        run: |
          anvil --block-time 1 &
          sleep 5

      - name: Deploy SuperPaymaster Stack (Anvil)
        run: |
          cd SuperPaymaster/contracts
          forge script script/DeployV3FullLocal.s.sol:DeployV3FullLocal --rpc-url http://localhost:8545 --broadcast --slow

      - name: Update SDK Env
        run: |
          # Copy .env.v3 template or generate from forge broadcast logs
          # In CI, we use fixed addresses from local deployment if deterministic, 
          # but here we rely on the .env.v3 already in the repo if it's updated.
          cd aastar-sdk
          # Optional: Script to extract addresses from SuperPaymaster logs if needed
          pnpm exec ts-node scripts/06_local_test_v3_admin.ts
          pnpm exec ts-node scripts/06_local_test_v3_reputation.ts
          pnpm exec ts-node scripts/06_local_test_v3_funding.ts
          pnpm exec ts-node scripts/06_local_test_v3_execution.ts

    services:
      # Optional: could use a service for anvil if preferred, but manual run is fine for now
